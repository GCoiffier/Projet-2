open Formula
let tseitin e = 
	let rec maxi e = match e with
		|Var(x) -> x
		|Const(_) -> 0
		|NOT(e1) -> maxi e1
		|OR(e1,e2) -> max (maxi e1) (maxi e2)
		|AND(e1,e2) -> max (maxi e1) (maxi e2)
		|IMPLIES(e1,e2) -> max (maxi e1) (maxi e2)
		|EQUIV(e1,e2) -> max (maxi e1) (maxi e2)
	in
	tseitin2 e ((maxi e)+1)

let rec tseitin2 e k = let q = !k in k := k+1
  match e with
  |Var(x) -> x,Const(true)
  |Const(true) -> Var(q), Var(q) (* q nouveau *)
  |Const(false) -> Var(q), NOT(Var(q))
  |NOT(e1) -> let l,t1 = tseitin2 e1 k in 
	      NOT(Var(q)), t1
  |OR(e1,e2) -> let l1,t1 = tseitin2 e1 k in let l2,t2 = tseitin2 e2 k in
		Var(q), AND(
			t1,
			AND(
			t2,
			AND(
				OR(
				NOT(l1),
				Var(q)), 
			AND(
				OR(
				NOT(l2),
				Var(q)) 
			,
				OR(
				NOT(Var(q)),
				OR(
				l1,
				l2))
			))))
  |AND(e1,e2) -> let l1,t1 = tseitin2 e1 k in let l2,t2 = tseitin2 e2 k in
		Var(q), AND(
			t1,
			AND(
			t2,
			AND(
				OR(
				l1,
				NOT(Var(q))), 
			AND(
				OR(
				l2,
				NOT(Var(q)))
			,
				OR(
				Var(q),
				OR(
				NOT(l1),
				NOT(l2)))
			))))
  |IMPLIES(e1,e2) -> let l1,t1 = tseitin2 e1 k in let l2,t2 = tseitin2 e2 k in
   		Var(q), AND(
			t1,
			AND(
			t2,
			AND(
				OR(
				l1,
				Var(q)),
			AND(
				OR(
				NOT(l2),
				Var(q))
			,
				OR(
				NOT(q),
				OR(
				NOT(l1),
				l2))			
			))))
  |EQUIV(e1,e2) -> let l1,t1 = tseitin2 e1 k in let l2,t2 = tseitin2 e2 k in
   		Var(q), AND(
			t1,
			AND(
			t2,
			AND(
				OR(
				NOT(Var(q)),
				OR(
				NOT(l1),
				l2)),
			AND(
				OR(
				NOT(Var(q)),
				OR(
				l1,
				NOT(l2))),
			AND(
				OR(
				Var(q),
				OR(
				l1,
				l2))
			,
				OR(
				Var(q),
				OR(
				NOT(l1),
				NOT(l2)))
			))))
